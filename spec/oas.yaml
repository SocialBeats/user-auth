openapi: 3.0.0
info:
  title: Users and Authentication Microservice
  version: v1.0.5
  description: This is an OAS description of this Microservice REST API
servers:
  - url: http://localhost:3000
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
paths:
  /api/v1/about:
    get:
      tags:
        - Documentation
      summary: Retrieve the entire README file as HTML.
      description: Reads the entire README file and returns its content as HTML.
      responses:
        '200':
          description: Successfully retrieved the README file content as HTML.
          content:
            text/html:
              schema:
                type: string
                description: The HTML content of the README file.
        '500':
          description: Error reading the README file.
          content:
            text/plain:
              schema:
                type: string
                description: Error message when the file cannot be read.
                example: 'Error reading the file: [error details]'
  /api/v1/version:
    get:
      tags:
        - Documentation
      summary: Retrieve the API version from the .version file.
      description: >-
        Reads the .version file and returns its content as part of a JSON
        message.
      responses:
        '200':
          description: Successfully retrieved the API version.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: The current API version.
                    example: v1.0.0
        '500':
          description: Error reading the .version file.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Error message summary.
                    example: There was an error retrieving API version
                  error:
                    type: string
                    description: Detailed error message.
                    example: 'ENOENT: no such file or directory, open ''.version'''
  /api/v1/changelog:
    get:
      tags:
        - Documentation
      summary: Retrieve the API changelog.
      description: >
        Reads the `CHANGELOG.md` file, parses its content, and returns it as
        HTML. Supports filtering by specific versions, multiple versions, or a
        version range.
      parameters:
        - in: query
          name: versions
          schema:
            type: string
          description: >
            Comma-separated list of release versions to retrieve (e.g.
            `v2.1.4,v2.1.2`).
        - in: query
          name: from
          schema:
            type: string
          description: >
            Starting release version for the changelog range (inclusive, e.g.
            `v2.1.2`).
        - in: query
          name: to
          schema:
            type: string
          description: >
            Ending release version for the changelog range (inclusive, e.g.
            `v2.1.4`).
      responses:
        '200':
          description: Successfully retrieved the changelog.
          content:
            text/html:
              schema:
                type: string
                description: The HTML representation of the changelog or filtered releases.
        '500':
          description: Error reading the CHANGELOG.md file.
          content:
            text/plain:
              schema:
                type: string
                description: Error message when the changelog cannot be read.
                example: >-
                  There was an error retrieving API release notes: ENOENT: no
                  such file or directory, open 'CHANGELOG.md'
  /api/v1/admin/create-admin:
    post:
      summary: Crea un nuevo usuario administrador
      description: |
        Crea un nuevo usuario con rol de administrador.
        Solo accesible por administradores existentes.
      tags:
        - Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  description: Nombre de usuario único
                  example: admin_user
                email:
                  type: string
                  format: email
                  description: Email único del administrador
                  example: admin@example.com
                password:
                  type: string
                  minLength: 6
                  description: Contraseña del administrador
                  example: secureAdminPass123
      responses:
        '201':
          description: Administrador creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Administrador creado exitosamente
        '400':
          description: Campos faltantes
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: MISSING_FIELDS
                  message:
                    type: string
                    example: Se necesitan el nombre de usuario, email y contraseña
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '409':
          description: Usuario o email ya existe
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: DUPLICATE_ENTRY
                  message:
                    type: string
                    example: El usuario ya existe
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: CREATION_FAILED
                  message:
                    type: string
                    example: Error al crear el administrador
  /api/v1/admin/users:
    get:
      summary: Lista todos los usuarios
      description: Obtiene una lista de todos los usuarios registrados en el sistema
      tags:
        - Admin
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de usuarios obtenida exitosamente
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                      description: ID del usuario
                      example: 507f1f77bcf86cd799439011
                    username:
                      type: string
                      example: john_doe
                    email:
                      type: string
                      example: john@example.com
                    roles:
                      type: array
                      items:
                        type: string
                      example:
                        - beatmaker
                    emailVerified:
                      type: boolean
                      example: true
                    createdAt:
                      type: string
                      format: date-time
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: FETCH_FAILED
                  message:
                    type: string
                    example: Error al obtener los usuarios
  /api/v1/admin/users/username/{username}:
    get:
      summary: Obtiene un usuario por su username
      description: >-
        Busca y devuelve los detalles de un usuario específico por su nombre de
        usuario
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
          description: Nombre de usuario a buscar
          example: john_doe
      responses:
        '200':
          description: Detalles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                    example: 507f1f77bcf86cd799439011
                  username:
                    type: string
                    example: john_doe
                  email:
                    type: string
                    example: john@example.com
                  roles:
                    type: array
                    items:
                      type: string
                    example:
                      - beatmaker
                  emailVerified:
                    type: boolean
                    example: true
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: USER_NOT_FOUND
                  message:
                    type: string
                    example: Usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: FETCH_FAILED
                  message:
                    type: string
                    example: Error al obtener el usuario
  /api/v1/admin/users/{id}:
    get:
      summary: Obtiene un usuario por su ID
      description: >-
        Busca y devuelve los detalles de un usuario específico por su ID de
        MongoDB
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID de MongoDB del usuario
          example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Detalles del usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                    example: 507f1f77bcf86cd799439011
                  username:
                    type: string
                    example: john_doe
                  email:
                    type: string
                    example: john@example.com
                  roles:
                    type: array
                    items:
                      type: string
                    example:
                      - beatmaker
                  emailVerified:
                    type: boolean
                    example: true
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: USER_NOT_FOUND
                  message:
                    type: string
                    example: Usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: FETCH_FAILED
                  message:
                    type: string
                    example: Error al obtener el usuario
    delete:
      summary: Elimina un usuario por su ID
      description: |
        Elimina permanentemente un usuario del sistema.
        Esta acción es irreversible.
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID de MongoDB del usuario a eliminar
          example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Usuario eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Usuario eliminado exitosamente
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: USER_NOT_FOUND
                  message:
                    type: string
                    example: Usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: DELETE_FAILED
                  message:
                    type: string
                    example: Error al eliminar el usuario
  /api/v1/admin/users/{username}:
    put:
      summary: Actualiza un usuario por su username
      description: Permite a un administrador actualizar cualquier campo de un usuario
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
          description: Nombre de usuario a actualizar
          example: john_doe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: Nuevo email
                roles:
                  type: array
                  items:
                    type: string
                  description: Nuevos roles del usuario
                emailVerified:
                  type: boolean
                  description: Estado de verificación del email
      responses:
        '200':
          description: Usuario actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Usuario actualizado exitosamente
                  user:
                    type: object
                    properties:
                      _id:
                        type: string
                      username:
                        type: string
                      email:
                        type: string
                      roles:
                        type: array
                        items:
                          type: string
        '401':
          description: No autenticado
        '403':
          description: Prohibido (requiere rol de administrador)
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: USER_NOT_FOUND
                  message:
                    type: string
                    example: Usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: UPDATE_FAILED
                  message:
                    type: string
                    example: Error al actualizar el usuario
  /api/v1/auth/register:
    post:
      summary: Registra un nuevo usuario como beatmaker
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  description: Nombre de usuario (único, mínimo 3 caracteres)
                  example: john_doe
                email:
                  type: string
                  format: email
                  description: Email del usuario (único)
                  example: john@example.com
                password:
                  type: string
                  minLength: 6
                  description: Contraseña (mínimo 6 caracteres)
                  example: mySecurePassword123
      responses:
        '201':
          description: Usuario registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User registered successfully
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_FIELDS
                      - INVALID_DATA_TYPE
                      - INVALID_USERNAME
                      - INVALID_PASSWORD
                      - INVALID_EMAIL
                    example: INVALID_EMAIL
                  message:
                    type: string
                    example: Email format is invalid
                  details:
                    type: object
                    description: Detalles específicos del error (solo para MISSING_FIELDS)
        '409':
          description: Usuario o email ya existe
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - USERNAME_EXISTS
                      - EMAIL_EXISTS
                    example: USERNAME_EXISTS
                  message:
                    type: string
                    example: Username already exists
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: REGISTRATION_FAILED
                  message:
                    type: string
                    example: Registration failed
  /api/v1/auth/login:
    post:
      summary: Inicia sesión y obtiene tokens de acceso
      description: >-
        Si el usuario tiene 2FA activado, devuelve 202 con tempToken para
        verificación
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - identifier
                - password
              properties:
                identifier:
                  type: string
                  description: Username o email del usuario
                  example: john_doe
                password:
                  type: string
                  description: Contraseña del usuario
                  example: mySecurePassword123
      responses:
        '200':
          description: Login exitoso con tokens (sin 2FA)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
                  accessToken:
                    type: string
                    description: Token de acceso (JWT, expira en 15 minutos)
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refreshToken:
                    type: string
                    description: Token de actualización (expira en 7 días)
                    example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
        '202':
          description: Requiere verificación 2FA
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 2FA verification required
                  require2FA:
                    type: boolean
                    example: true
                  tempToken:
                    type: string
                    description: Token temporal para completar 2FA (expira en 5 minutos)
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_FIELDS
                      - INVALID_DATA_TYPE
                      - EMPTY_FIELDS
                    example: MISSING_FIELDS
                  message:
                    type: string
                    example: Identifier and password are required
                  details:
                    type: object
                    description: Detalles específicos del error
        '401':
          description: Credenciales inválidas
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: INVALID_CREDENTIALS
                  message:
                    type: string
                    example: Invalid credentials
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: LOGIN_FAILED
                  message:
                    type: string
                    example: Login failed
  /api/v1/auth/refresh:
    post:
      summary: Refresca el access token usando un refresh token
      description: >-
        Genera nuevos tokens de acceso usando el refresh token. Implementa
        rotación de refresh tokens.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Refresh token actual
                  example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
      responses:
        '200':
          description: Nuevos tokens generados exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token actualizado exitosamente
                  accessToken:
                    type: string
                    description: Nuevo access token (JWT)
                  refreshToken:
                    type: string
                    description: Nuevo refresh token (rotado)
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_REFRESH_TOKEN
                      - INVALID_DATA_TYPE
                      - EMPTY_REFRESH_TOKEN
                    example: MISSING_REFRESH_TOKEN
                  message:
                    type: string
                    example: Se necesita el refresh token
        '401':
          description: Refresh token inválido o expirado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: INVALID_REFRESH_TOKEN
                  message:
                    type: string
                    example: El refresh token es inválido o ha expirado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: REFRESH_FAILED
                  message:
                    type: string
                    example: Error al actualizar el token
  /api/v1/auth/logout:
    post:
      summary: Cierra sesión revocando tokens (refresh y opcionalmente access)
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Refresh token a revocar (requerido)
                  example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
                accessToken:
                  type: string
                  description: Access token a revocar (opcional, recomendado)
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Logout exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_REFRESH_TOKEN
                      - INVALID_DATA_TYPE
                    example: MISSING_REFRESH_TOKEN
                  message:
                    type: string
                    example: Refresh token is required
        '404':
          description: Token no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: TOKEN_NOT_FOUND
                  message:
                    type: string
                    example: Refresh token not found
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: LOGOUT_FAILED
                  message:
                    type: string
                    example: Logout failed
  /api/v1/auth/revoke-all:
    post:
      summary: Revoca todos los tokens de un usuario
      description: >
        Revoca todos los access y refresh tokens activos del usuario
        autenticado.

        Útil para cerrar sesión en todos los dispositivos.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Todos los tokens revocados exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Todos los tokens han sido revocados exitosamente
                  revokedCount:
                    type: integer
                    description: Número de tokens revocados
                    example: 5
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: AUTHENTICATION_REQUIRED
                  message:
                    type: string
                    example: Autenticación requerida
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: REVOKE_FAILED
                  message:
                    type: string
                    example: Error al revocar los tokens
  /api/v1/auth/validate-token:
    post:
      summary: Valida un access token contra Redis
      description: |
        Endpoint interno usado por el API Gateway para validar tokens.
        Verifica que el token no haya sido revocado en Redis.
        Devuelve siempre 200 con `valid: true/false`.
      tags:
        - Internal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Access token (JWT) a validar
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Resultado de la validación (siempre devuelve 200)
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    description: true si el token es válido, false si no
                  user:
                    type: object
                    description: Datos del usuario (solo si valid=true)
                    properties:
                      id:
                        type: string
                        example: 507f1f77bcf86cd799439011
                      username:
                        type: string
                        example: john_doe
                      email:
                        type: string
                        example: john@example.com
                      roles:
                        type: array
                        items:
                          type: string
                        example:
                          - beatmaker
                  error:
                    type: string
                    description: Código de error (solo si valid=false)
                    enum:
                      - MISSING_TOKEN
                      - INVALID_TOKEN
                  message:
                    type: string
                    description: Mensaje de error (solo si valid=false)
        '400':
          description: Token no proporcionado
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: MISSING_TOKEN
                  message:
                    type: string
                    example: Token no proporcionado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: VALIDATION_FAILED
                  message:
                    type: string
                    example: Error en la validación del token
  /api/v1/auth/verify-email:
    get:
      summary: Verifica el email del usuario usando un token
      tags:
        - Auth
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Token de verificación enviado por email
      responses:
        '200':
          description: Email verificado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email verified successfully
                  emailVerified:
                    type: boolean
                    example: true
                  username:
                    type: string
                    example: john_doe
        '400':
          description: Token inválido o expirado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_TOKEN
                      - INVALID_TOKEN
                  message:
                    type: string
  /api/v1/auth/resend-verification:
    post:
      summary: Reenvía el email de verificación
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: Email del usuario
                  example: john@example.com
      responses:
        '200':
          description: Email de verificación reenviado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent successfully
        '400':
          description: Email ya verificado o formato inválido
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_EMAIL
                      - INVALID_EMAIL
                      - ALREADY_VERIFIED
                  message:
                    type: string
        '404':
          description: Usuario no encontrado
  /api/v1/auth/forgot-password:
    post:
      summary: Solicita el restablecimiento de contraseña
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: Email del usuario
                  example: john@example.com
      responses:
        '200':
          description: Solicitud procesada (siempre devuelve éxito por seguridad)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a reset link will be sent
  /api/v1/auth/reset-password:
    post:
      summary: Restablece la contraseña usando un token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - password
              properties:
                token:
                  type: string
                  description: Token de restablecimiento enviado por email
                password:
                  type: string
                  minLength: 6
                  description: Nueva contraseña (mínimo 6 caracteres)
                  example: myNewSecurePassword123
      responses:
        '200':
          description: Contraseña restablecida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully
        '400':
          description: Token inválido, expirado, o contraseña inválida
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_FIELDS
                      - INVALID_TOKEN
                      - INVALID_PASSWORD
                  message:
                    type: string
  /api/v1/auth/change-password:
    put:
      summary: Cambia la contraseña del usuario autenticado
      description: >-
        Permite a un usuario cambiar su contraseña proporcionando la contraseña
        actual
      tags:
        - Auth
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  description: Contraseña actual
                  example: myCurrentPassword123
                newPassword:
                  type: string
                  minLength: 8
                  description: Nueva contraseña (mínimo 8 caracteres)
                  example: myNewSecurePassword123
      responses:
        '200':
          description: Contraseña cambiada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          description: Campos faltantes o contraseña inválida
        '401':
          description: No autenticado o contraseña actual incorrecta
        '404':
          description: Usuario no encontrado
  /api/v1/auth/internal/user/{id}:
    delete:
      summary: Elimina un usuario (endpoint interno)
      description: >
        Endpoint protegido por x-internal-api-key para uso entre microservicios.

        Elimina permanentemente la cuenta del usuario, su perfil, revoca todos
        los tokens

        y publica evento Kafka USER_DELETED.
      tags:
        - Internal
      parameters:
        - in: header
          name: x-internal-api-key
          required: true
          schema:
            type: string
          description: API Key interna para autenticación entre microservicios
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del usuario a eliminar (MongoDB ObjectId)
      responses:
        '200':
          description: Usuario eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Account deleted successfully
                  deletedAt:
                    type: string
                    format: date-time
        '400':
          description: ID de usuario inválido o faltante
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_USER_ID
                      - INVALID_USER_ID
                  message:
                    type: string
        '401':
          description: API Key interna inválida o faltante
        '404':
          description: Usuario no encontrado
        '500':
          description: Error del servidor
  /api/v1/health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns basic information to verify that the API is running properly.
      responses:
        '200':
          description: API is healthy and responding.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Health check successful
                  version:
                    type: string
                    example: 1.0.0
                  uptime:
                    type: number
                    example: 123.45
                  timestamp:
                    type: string
                    format: date-time
                    example: '2025-11-08T13:41:47.074Z'
                  environment:
                    type: string
                    example: development
                  db:
                    type: string
                    example: connected
  /api/v1/kafka/health:
    get:
      tags:
        - Kafka
      summary: Kafka health check
      description: Verifies whether Kafka is currently reachable and responding.
      responses:
        '200':
          description: Kafka is running and the connection is successful.
          content:
            application/json:
              schema:
                type: object
                properties:
                  kafka:
                    type: string
                    example: connected
        '503':
          description: Kafka is not reachable or connection failed.
          content:
            application/json:
              schema:
                type: object
                properties:
                  kafka:
                    type: string
                    example: disconnected
  /api/v1/profile/internal/{userId}/verification-status:
    put:
      tags:
        - Internal
      summary: Actualizar estado de verificación (Interno)
      description: >
        Endpoint protegido por API Key interna para actualizar estado de
        verificación desde FaaS/Webhooks.

        Usado por el sistema de verificación de identidad (Persona).
      parameters:
        - in: header
          name: x-internal-api-key
          required: true
          schema:
            type: string
          description: API Key interna para autenticación entre microservicios
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: ID del usuario (MongoDB ObjectId)
          example: 507f1f77bcf86cd799439011
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - VERIFICADO
                    - PENDING
                    - REJECTED
                  description: Nuevo estado de verificación
                provider_id:
                  type: string
                  description: ID del proveedor de verificación (Persona)
      responses:
        '200':
          description: Estado actualizado correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Estado de verificación actualizado correctamente
        '401':
          description: API Key interna inválida o faltante
        '404':
          description: Perfil de usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Perfil de usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Error interno del servidor
  /api/v1/profile/me:
    get:
      tags:
        - Profile
      summary: Obtener mi perfil
      description: Obtiene el perfil del usuario autenticado
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  username:
                    type: string
                  email:
                    type: string
                  about_me:
                    type: string
                  avatar:
                    type: string
                  full_name:
                    type: string
                  contact:
                    type: object
                  studies:
                    type: array
                  tags:
                    type: array
                    items:
                      type: string
                  certifications:
                    type: array
        '401':
          description: No autenticado
        '404':
          description: Perfil no encontrado
    put:
      tags:
        - Profile
      summary: Actualizar mi perfil
      description: Actualiza el perfil del usuario autenticado
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                about_me:
                  type: string
                avatar:
                  type: string
                full_name:
                  type: string
                contact:
                  type: object
                  properties:
                    phone:
                      type: string
                    city:
                      type: string
                    country:
                      type: string
                    website:
                      type: string
                    social_media:
                      type: object
                studies:
                  type: array
                tags:
                  type: array
                  items:
                    type: string
                certifications:
                  type: array
      responses:
        '200':
          description: Perfil actualizado exitosamente
        '400':
          description: Datos inválidos
        '401':
          description: No autenticado
        '404':
          description: Perfil no encontrado
    delete:
      tags:
        - Profile
      summary: Eliminar mi cuenta permanentemente
      description: >
        Elimina permanentemente la cuenta del usuario autenticado.

        Esta acción es IRREVERSIBLE. Elimina:

        - La cuenta del usuario (User)

        - El perfil asociado (Profile)

        - Revoca todos los tokens activos

        - Publica evento Kafka `USER_DELETED` para limpieza en otros
        microservicios
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cuenta eliminada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Account deleted successfully
                  deletedAt:
                    type: string
                    format: date-time
        '401':
          description: No autenticado
        '404':
          description: Usuario no encontrado
        '500':
          description: Error del servidor
  /api/v1/profile/me/completion-status:
    get:
      tags:
        - Profile
      summary: Obtener estado de completitud del perfil
      description: Obtiene el progreso de completitud del perfil por pasos
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Estado de completitud obtenido
          content:
            application/json:
              schema:
                type: object
                properties:
                  steps:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        label:
                          type: string
                        required:
                          type: boolean
                        completed:
                          type: boolean
                  completionPercentage:
                    type: integer
                  verificationLevel:
                    type: string
                    enum:
                      - none
                      - basic
                      - advanced
                      - verified
                  nextStep:
                    type: object
        '401':
          description: No autenticado
        '404':
          description: Perfil no encontrado
  /api/v1/profile:
    get:
      tags:
        - Profile
      summary: Explorar todos los perfiles
      description: Obtiene una lista paginada de todos los perfiles públicos
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Número de página
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Número de resultados por página
      responses:
        '200':
          description: Lista de perfiles obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  profiles:
                    type: array
                    items:
                      type: object
                      properties:
                        userId:
                          type: string
                        username:
                          type: string
                        full_name:
                          type: string
                        avatar:
                          type: string
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 150
                      page:
                        type: integer
                        example: 1
                      pages:
                        type: integer
                        example: 8
                      limit:
                        type: integer
                        example: 20
        '500':
          description: Error del servidor
  /api/v1/profile/search:
    get:
      tags:
        - Profile
      summary: Buscar perfiles
      description: Busca perfiles por username, nombre completo o email
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 1
          description: Término de búsqueda (username, email, nombre)
          example: john
      responses:
        '200':
          description: Lista de perfiles encontrados
          content:
            application/json:
              schema:
                type: object
                properties:
                  profiles:
                    type: array
                    items:
                      type: object
                      properties:
                        userId:
                          type: string
                          example: 507f1f77bcf86cd799439011
                        username:
                          type: string
                          example: john_doe
                        full_name:
                          type: string
                          example: John Doe
                        avatar:
                          type: string
                          example: https://cdn.example.com/avatars/john.jpg
                        email:
                          type: string
                          example: john@example.com
        '400':
          description: Término de búsqueda faltante
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: MISSING_SEARCH_TERM
                  message:
                    type: string
                    example: El término de búsqueda (q) es requerido
        '500':
          description: Error del servidor
  /api/v1/profile/{identifier}:
    get:
      tags:
        - Profile
      summary: Obtener perfil por userId o username
      description: >
        Obtiene el perfil público de un usuario.

        Detecta automáticamente si el parámetro es un userId (ObjectId de 24
        caracteres hex) o un username.
      parameters:
        - in: path
          name: identifier
          required: true
          schema:
            type: string
          description: userId (ObjectId) o username del usuario
          example: john_doe
      responses:
        '200':
          description: Perfil obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    example: 507f1f77bcf86cd799439011
                  username:
                    type: string
                    example: john_doe
                  email:
                    type: string
                    example: john@example.com
                  about_me:
                    type: string
                    example: Soy un beatmaker de Madrid
                  avatar:
                    type: string
                    example: https://cdn.example.com/avatars/john.jpg
                  banner:
                    type: string
                    example: https://cdn.example.com/banners/john.jpg
                  full_name:
                    type: string
                    example: John Doe
                  contact:
                    type: object
                  studies:
                    type: array
                  tags:
                    type: array
                    items:
                      type: string
                  certifications:
                    type: array
                  identityVerified:
                    type: boolean
                    example: false
                  verificationLevel:
                    type: string
                    enum:
                      - none
                      - verified
                    example: none
        '404':
          description: Perfil no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: PROFILE_NOT_FOUND
                  message:
                    type: string
                    example: Perfil no encontrado
        '500':
          description: Error del servidor
  /api/v1/auth/2fa/status:
    get:
      summary: Obtiene el estado de 2FA del usuario
      description: Devuelve si el usuario tiene 2FA activado o no
      tags:
        - 2FA
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Estado de 2FA
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                    description: true si 2FA está activado
                    example: false
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: AUTHENTICATION_REQUIRED
                  message:
                    type: string
                    example: Autenticación requerida
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 2FA_STATUS_FAILED
                  message:
                    type: string
                    example: Error al obtener el estado de 2FA
  /api/v1/auth/2fa/setup:
    post:
      summary: Inicia la configuración de 2FA
      description: Genera el secreto TOTP y el código QR para escanear
      tags:
        - 2FA
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Setup iniciado con éxito
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 2FA setup initiated
                  secret:
                    type: string
                    description: Secreto TOTP para introducir manualmente
                    example: JBSWY3DPEHPK3PXP
                  qrCode:
                    type: string
                    description: QR code en formato data URL (base64)
                  otpauthUrl:
                    type: string
                    description: URL otpauth para configuración manual
        '400':
          description: 2FA ya está activado
        '401':
          description: No autenticado
  /api/v1/auth/2fa/enable:
    post:
      summary: Activa 2FA después de verificar un código
      description: Verifica el código OTP y activa 2FA, devuelve códigos de backup
      tags:
        - 2FA
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  description: Código OTP de 6 dígitos
                  example: '123456'
      responses:
        '200':
          description: 2FA activado con éxito
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 2FA enabled successfully
                  enabled:
                    type: boolean
                    example: true
                  backupCodes:
                    type: array
                    items:
                      type: string
                    description: Códigos de backup de un solo uso
        '400':
          description: Código inválido o 2FA ya activado
        '401':
          description: No autenticado
  /api/v1/auth/2fa/disable:
    post:
      summary: Desactiva 2FA
      description: Desactiva 2FA después de verificar un código OTP o backup
      tags:
        - 2FA
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  description: Código OTP de 6 dígitos o código de backup
                  example: '123456'
      responses:
        '200':
          description: 2FA desactivado con éxito
        '400':
          description: Código inválido o 2FA no activado
        '401':
          description: No autenticado
  /api/v1/auth/2fa/backup-codes:
    get:
      summary: Obtiene los códigos de backup restantes
      tags:
        - 2FA
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Códigos de backup
          content:
            application/json:
              schema:
                type: object
                properties:
                  backupCodes:
                    type: array
                    items:
                      type: string
                  remaining:
                    type: integer
                    example: 8
        '400':
          description: 2FA no activado
        '401':
          description: No autenticado
  /api/v1/auth/2fa/regenerate-backup:
    post:
      summary: Regenera los códigos de backup
      description: Genera nuevos códigos de backup después de verificar código OTP
      tags:
        - 2FA
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  description: Código OTP de 6 dígitos
                  example: '123456'
      responses:
        '200':
          description: Códigos regenerados con éxito
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  backupCodes:
                    type: array
                    items:
                      type: string
        '400':
          description: Código inválido o 2FA no activado
        '401':
          description: No autenticado
  /api/v1/auth/2fa/verify:
    post:
      summary: Verifica el código 2FA durante el login
      description: >
        Canjea el tempToken + código OTP por tokens de acceso.

        Este endpoint se usa después de que login devuelve 202 con
        require2FA=true.
      tags:
        - 2FA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tempToken
                - code
              properties:
                tempToken:
                  type: string
                  description: Token temporal recibido en el login (expira en 5 min)
                  example: abc123def456
                code:
                  type: string
                  description: Código OTP de 6 dígitos o código de backup
                  example: '123456'
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login exitoso
                  accessToken:
                    type: string
                    description: Token de acceso JWT
                  refreshToken:
                    type: string
                    description: Token de actualización
        '400':
          description: Campos faltantes
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - MISSING_TEMP_TOKEN
                      - MISSING_CODE
                    example: MISSING_CODE
                  message:
                    type: string
                    example: Se necesita un código de verificación
        '401':
          description: Código o token inválido
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: INVALID_CODE
                  message:
                    type: string
                    example: Código de verificación inválido
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: USER_NOT_FOUND
                  message:
                    type: string
                    example: Usuario no encontrado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: 2FA_VERIFY_FAILED
                  message:
                    type: string
                    example: Error al verificar el código 2FA
  /api/v1/auth/upload/presigned-url:
    get:
      summary: Obtiene una URL prefirmada para subir archivos a S3
      description: |
        Genera una URL prefirmada de S3 para subida directa desde el cliente.
        La URL expira en 60 segundos.
        Para certificaciones, valida el límite del plan del usuario.
      tags:
        - Upload
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: fileName
          required: true
          schema:
            type: string
          description: Nombre del archivo a subir
          example: mi_certificado.pdf
        - in: query
          name: fileType
          required: true
          schema:
            type: string
          description: Tipo MIME del archivo
          example: application/pdf
        - in: query
          name: category
          required: false
          schema:
            type: string
            enum:
              - avatar
              - certification
              - banner
            default: avatar
          description: >-
            Categoría del archivo (determina tipos permitidos y carpeta de
            destino)
      responses:
        '200':
          description: URL prefirmada generada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  uploadUrl:
                    type: string
                    description: URL prefirmada para subir el archivo (expira en 60s)
                    example: https://bucket.s3.amazonaws.com/...
                  finalUrl:
                    type: string
                    description: URL pública final del archivo en el CDN
                    example: https://cdn.example.com/avatars/1234567890-mi_avatar.jpg
                  fileName:
                    type: string
                    description: Nombre único del archivo en S3
                    example: avatars/1234567890-mi_avatar.jpg
        '400':
          description: Parámetros inválidos o límite de plan excedido
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Faltan parámetros fileName y fileType son requeridos
        '401':
          description: No autenticado
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Error al generar URL de subida
  /api/v1/auth/upload/certification/{certificationId}:
    delete:
      summary: Elimina una certificación del perfil
      description: >
        Elimina una certificación del perfil del usuario autenticado.

        Esta acción:

        - Elimina el archivo de S3

        - Decrementa el contador de certificados en Space (libera cuota del
        plan)

        - Elimina la entrada del array de certificaciones en el perfil
      tags:
        - Upload
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: certificationId
          required: true
          schema:
            type: string
          description: ID de MongoDB de la certificación a eliminar
          example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Certificación eliminada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Certificación eliminada correctamente
                  certifications:
                    type: array
                    description: Array actualizado de certificaciones del usuario
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                        name:
                          type: string
                        url:
                          type: string
        '401':
          description: No autenticado
        '404':
          description: Perfil o certificación no encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum:
                      - Perfil no encontrado
                      - Certificación no encontrada
        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Error al eliminar la certificación
tags: []
